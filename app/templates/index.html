<!DOCTYPE html>
<html lang="es">
<head>
    <title>Chat con Llama 3 - Voces Naturales Microsoft</title>
    <meta charset="utf-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #333;
            
            font-size: 28px;
        }
        
        .voice-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .voice-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .voice-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .voice-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .voice-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }
        
        .voice-option .flag {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .voice-option .name {
            font-size: 13px;
            font-weight: 600;
        }
        
        .voice-option .gender {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        #chat {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }
        
        .message {
            margin: 12px 0;
            padding: 14px 18px;
            border-radius: 15px;
            animation: fadeIn 0.3s ease-in;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: right;
            margin-left: 20%;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .bot-message {
            background: white;
            color: #333;
            margin-right: 20%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .speak-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .bot-message .speak-button {
            background: #f0f0f0;
        }
        
        .speak-button:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.4);
        }
        
        .speak-button.speaking {
            animation: pulse 1s infinite;
            background: #f5576c;
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(245, 87, 108, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 87, 108, 0); }
        }
        
        .controls-container {
            display: flex;
            gap: 10px;
        }
        
        #message {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 30px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        #message:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }
        
        button {
            padding: 14px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .voice-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-width: 60px;
            padding: 14px;
            justify-content: center;
        }
        
        .voice-button.recording {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            animation: recordPulse 1.5s infinite;
        }
        
        @keyframes recordPulse {
            0% { box-shadow: 0 0 0 0 rgba(250, 112, 154, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(250, 112, 154, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 112, 154, 0); }
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .loading.show {
            display: block;
        }
        
        .settings-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #667eea;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active::after {
            transform: translateX(26px);
        }
        
        input[type="range"] {
            width: 100px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: #e8f4e8;
            color: #2e7d2e;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-indicator.error {
            background: #ffe5e5;
            color: #d32f2f;
        }

        .info-banner {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"> 
            <div class="logo">
                <span style="font-size: 40px;">🎓</span>
                <h1>Asistente Educativo Inteligente</h1>
                <span style="font-size: 40px;">📚</span>
            </div>
            <div class="subtitle">Secretaría de Educación</div>
        </div>
        
       
        
        <div class="voice-selector">
            
            <div class="settings-row">
                <div class="setting-item">
                    <label>🔊 Auto-reproducir voz:</label>
                    <div class="toggle-switch" id="autoSpeakToggle" onclick="toggleAutoSpeak()"></div>
                </div>
               
            </div>
        </div>
        
        <div id="chat"></div>
        <div class="loading" id="loading">
            <span>🤔 Procesando...</span>
        </div>
        
        <div class="controls-container">
            <input type="text" id="message" placeholder="Escribe tu mensaje o usa el micrófono..." autocomplete="off">
            <button id="sendBtn" onclick="sendMessage()">
                📤 Enviar
            </button>
            <button class="voice-button" id="voiceBtn" onclick="toggleVoiceRecording()">
                🎤
            </button>
        </div>
    </div>

    <script>
  // Config
  const FIXED_RATE = 1.0;

  // Variables globales
  let selectedVoice = 'gonzalo'; // Voz fija
  let autoSpeak = true;          // Auto-reproducir siempre activo
  let recognition = null;
  let isRecording = false;
  let messageCounter = 0;
  let currentAudio = null;
  let isSpeaking = false;
  let useEdgeTTS = true; // Edge TTS si está disponible

  // Inicialización
  document.addEventListener('DOMContentLoaded', () => {
    // Marcar visualmente el toggle como activo (si existe)
    const toggle = document.getElementById('autoSpeakToggle');
    if (toggle) toggle.classList.add('active');

    // Asegurar voz Gonzalo sin depender del DOM
    selectVoice('gonzalo');

    // Inicializar features
    initializeSpeechRecognition();
    setupEventListeners();
    checkEdgeTTSAvailability();
    showWelcomeMessage();
    const msg = document.getElementById('message');
    if (msg) msg.focus();
  });

  // Verificar disponibilidad de Edge TTS
  async function checkEdgeTTSAvailability() {
    try {
      const response = await fetch('/voices');
      if (response.ok) {
        const data = await response.json();
        console.log('✅ Edge TTS disponible con voces:', data);
        useEdgeTTS = true;
        updateStatus('✅ Voces naturales Microsoft listas', false);
      } else {
        useEdgeTTS = false;
        updateStatus('⚠️ Usando voces del sistema', true);
      }
    } catch (error) {
      console.error('Error verificando Edge TTS:', error);
      useEdgeTTS = false;
      updateStatus('⚠️ Usando voces del sistema', true);
    }
  }

  // Actualizar indicador de estado (no falla si no existe)
  function updateStatus(text, isError = false) {
    const indicator = document.getElementById('statusIndicator');
    if (!indicator) return; // No hay indicador en el DOM actual
    indicator.textContent = text;
    indicator.classList.toggle('error', !!isError);
  }

  // Seleccionar voz (seguro aunque no haya tarjetas de voz en el DOM)
  function selectVoice(voice) {
    selectedVoice = voice;
    const option = document.querySelector(`[data-voice="${voice}"]`);
    if (option) {
      document.querySelectorAll('.voice-option').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
    }
    console.log('Voz seleccionada:', voice);
  }

  // Toggle auto-speak (si quieres que nunca se apague, fuerza true aquí)
  function toggleAutoSpeak() {
    autoSpeak = !autoSpeak;
    const toggle = document.getElementById('autoSpeakToggle');
    if (toggle) toggle.classList.toggle('active', autoSpeak);
  }

  // Probar voz
  async function testVoice() {
    const testText = "Hola, soy tu asistente de inteligencia artificial con voz natural. ¿En qué puedo ayudarte hoy?";
    await speakWithEdgeTTS(testText);
  }

  // Hablar con Edge TTS (velocidad fija 1.0)
  async function speakWithEdgeTTS(text, button = null) {
    if (!useEdgeTTS) {
      // Fallback a síntesis del navegador
      speakWithBrowserTTS(text, button);
      return;
    }

    // Detener audio anterior si existe
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }

    if (button) button.classList.add('speaking');

    try {
      const response = await fetch('/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, voice: selectedVoice })
      });

      if (!response.ok) throw new Error('Error generando audio');

      const data = await response.json();

      // Crear y reproducir audio
      currentAudio = new Audio(data.audio);
      currentAudio.playbackRate = FIXED_RATE; // SIEMPRE 1.0

      currentAudio.onended = () => {
        if (button) button.classList.remove('speaking');
        isSpeaking = false;
        currentAudio = null;
      };

      currentAudio.onerror = () => {
        if (button) button.classList.remove('speaking');
        isSpeaking = false;
        console.error('Error reproduciendo audio');
      };

      isSpeaking = true;
      await currentAudio.play();

    } catch (error) {
      console.error('Error con Edge TTS:', error);
      if (button) button.classList.remove('speaking');
      // Fallback a síntesis del navegador
      speakWithBrowserTTS(text, button);
    }
  }

   function showWelcomeMessage() {
            const chatDiv = document.getElementById('chat');
            chatDiv.innerHTML = `
                <div class="message bot-message">
                    <b>🤖 Asistente:</b> ¡Bienvenido al sistema de consultas educativas! 
                    Puedo responder preguntas basándome en los documentos oficiales de la Secretaría de Educación.
                    <br><br>
                    ¿En qué puedo ayudarte hoy?
                </div>
            `;
        }

  // Fallback: síntesis del navegador (velocidad fija 1.0)
  function speakWithBrowserTTS(text, button = null) {
    if (!window.speechSynthesis) {
      console.error('Síntesis de voz no disponible');
      return;
    }

    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'es-ES';
    utterance.rate = FIXED_RATE; // SIEMPRE 1.0

    if (button) {
      utterance.onstart = () => button.classList.add('speaking');
      utterance.onend = () => button.classList.remove('speaking');
      utterance.onerror = () => button.classList.remove('speaking');
    }

    window.speechSynthesis.speak(utterance);
  }

  // Configurar reconocimiento de voz
  function initializeSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) return;

    recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = () => {
      console.log('Reconocimiento iniciado');
      const btn = document.getElementById('voiceBtn');
      if (btn) btn.classList.add('recording');
      const input = document.getElementById('message');
      if (input) input.placeholder = '🎤 Escuchando...';
    };

    recognition.onresult = (event) => {
      let finalTranscript = '';
      let interimTranscript = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) finalTranscript += transcript;
        else interimTranscript += transcript;
      }

      const input = document.getElementById('message');
      if (input) input.value = finalTranscript || interimTranscript;

      if (finalTranscript) sendMessage();
    };

    recognition.onerror = (event) => {
      console.error('Error en reconocimiento:', event.error);
      stopRecording();
    };

    recognition.onend = () => {
      stopRecording();
    };
  }

  // Toggle grabación
  function toggleVoiceRecording() {
    if (!recognition) {
      alert('El reconocimiento de voz no está disponible');
      return;
    }

    if (isRecording) {
      recognition.stop();
    } else {
      // Detener audio si está reproduciéndose
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      if (window.speechSynthesis && window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
      }

      recognition.start();
      isRecording = true;
    }
  }

  // Detener grabación
  function stopRecording() {
    isRecording = false;
    const btn = document.getElementById('voiceBtn');
    if (btn) btn.classList.remove('recording');
    const input = document.getElementById('message');
    if (input) input.placeholder = 'Escribe tu mensaje o usa el micrófono...';
  }

  // Enviar mensaje
  async function sendMessage() {
    const messageInput = document.getElementById('message');
    const chatDiv = document.getElementById('chat');
    const loadingDiv = document.getElementById('loading');
    const sendBtn = document.getElementById('sendBtn');

    if (!messageInput || !chatDiv) return;

    const message = messageInput.value.trim();
    if (!message) return;

    // ID único para mensajes
    const userMsgId = `user-${messageCounter++}`;
    const botMsgId = `bot-${messageCounter++}`;

    // Mostrar mensaje del usuario
    chatDiv.innerHTML += `
      <div class="message user-message" id="${userMsgId}">
        <button class="speak-button" onclick="speakMessage('${escapeForSpeech(message)}', this)" title="Reproducir">🔊</button>
        <b>Tú:</b> ${escapeHtml(message)}
      </div>
    `;

    // Limpiar y deshabilitar
    messageInput.value = '';
    if (sendBtn) sendBtn.disabled = true;
    if (loadingDiv) loadingDiv.classList.add('show');

    if (isRecording && recognition) recognition.stop();

    chatDiv.scrollTop = chatDiv.scrollHeight;

    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: message })
      });

      if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

      const data = await response.json();
      if (data.error) throw new Error(data.error);

      // Mostrar respuesta
      const botResponse = data.response;
      chatDiv.innerHTML += `
        <div class="message bot-message" id="${botMsgId}">
          <button class="speak-button" onclick="speakMessage('${escapeForSpeech(botResponse)}', this)" title="Reproducir">🔊</button>
          <b>🤖 Asistente:</b> ${escapeHtml(botResponse)}
        </div>
      `;

      // Auto-reproducir si está activado
      if (autoSpeak) {
        setTimeout(async () => {
          const button = document.querySelector(`#${botMsgId} .speak-button`);
          await speakWithEdgeTTS(botResponse, button);
        }, 100);
      }

    } catch (error) {
      console.error('Error:', error);
      chatDiv.innerHTML += `
        <div class="message bot-message" style="background: #ffe5e5; color: #e74c3c;">
          <b>Error:</b> ${escapeHtml(error.message)}
        </div>
      `;
    } finally {
      if (sendBtn) sendBtn.disabled = false;
      if (loadingDiv) loadingDiv.classList.remove('show');
      messageInput.focus();
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
  }

  // Hablar mensaje
  async function speakMessage(text, button) {
    await speakWithEdgeTTS(text, button);
  }

  // Event listeners (solo Enter; sin slider de velocidad)
  function setupEventListeners() {
    const input = document.getElementById('message');
    if (input) {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }
  }

  // Utilidades
  function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  function escapeForSpeech(text) {
    return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, ' ');
  }
</script>

</body>
</html>